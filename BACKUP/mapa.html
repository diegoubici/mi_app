<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa de Pol√≠gonos</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; }
header { background-color: #0056b3; color: white; padding: 10px; height:50px; }
header h2 { margin:0; font-size:18px; display:inline-block; }
header span { float:right; line-height:30px; }
#container { display:flex; height:calc(100vh - 50px); }
#map { flex:2; height:100%; }
#tabla-container { flex:1; overflow:auto; border-left:2px solid #ccc; background:#f9f9f9; padding:10px; font-size:11px; text-transform:uppercase; }

table.dataTable thead th { background-color:#0056b3; color:white; text-align:left; font-weight:bold; font-size:11px; }
table.dataTable tbody tr { height: 24px; }
table.dataTable td { text-align:left; vertical-align:middle; }
td input { width:95%; border:none; background:transparent; font-size:11px; padding:1px 2px; box-sizing:border-box; text-transform:uppercase; }
td input:hover, td input:focus { background:#eef; outline:none; }
#tablaPoligonos input[type="color"] { width:30px; height:20px; padding:0; border:none; }

th:nth-child(1), td:nth-child(1) { width:45px; }
th:nth-child(2), td:nth-child(2) { width:200px; }
th:nth-child(3), td:nth-child(3) { width:80px; }
th:nth-child(4), td:nth-child(4) { width:90px; }
th:nth-child(5), td:nth-child(5) { width:90px; }
th:nth-child(6), td:nth-child(6) { width:60px; }

button { margin-top:5px; background-color:#0056b3; color:white; border:none; padding:6px 10px; cursor:pointer; border-radius:4px; font-size:11px; }
button:hover { background-color:#003f80; }
#botonera { display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px; }
#botonera button, #botonera input, #botonera select { font-size:11px; }

#filtros { display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap; }
#filtros input { flex:1; min-width:50px; font-size:11px; padding:3px; }

tr.seleccionado {
    background: radial-gradient(circle at center, #FFF4E9 40%, #FFDAC1 100%) !important;
    box-shadow: 0 0 10px rgba(0,0,0,0.25);
    position: relative;
    z-index: 1;
    transition: background 0.4s ease, box-shadow 0.4s ease;
}
.menu-grabar {
  display: none;
  position: absolute;
  background-color: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  min-width: 160px;
  z-index: 2000;
  top: 35px;
  left: 0;
}
.menu-grabar div {
  padding: 8px 12px;
  font-size: 11px;
  cursor: pointer;
  transition: background 0.2s;
}
.menu-grabar div:hover {
  background-color: #f0f0f0;
}
</style>
</head>
<body>

<header>
<h2>Mapa de Pol√≠gonos - {{ usuario }}</h2>
<span><a href="/logout" style="color:white;">Cerrar sesi√≥n</a></span>
</header>

<div id="container">
<div id="map"></div>

<div id="tabla-container">
<h3 style="margin-top:0;">Editar atributos</h3>

<div id="botonera">
<!-- Bloque de color en bloque -->
<label>Color en bloque:</label>
<select id="colorBloque">
  <option value="">-- ELEGIR COLOR --</option>
  {% for c in [
      {"nombre":"ROJO","codigo":"#FF0000"},
      {"nombre":"VERDE","codigo":"#00FF00"},
      {"nombre":"AZUL","codigo":"#0000FF"},
      {"nombre":"VERDE MENTA","codigo":"#B5EAD7"},
      {"nombre":"DURAZNO SUAVE","codigo":"#FFDAC1"},
      {"nombre":"LAVANDA","codigo":"#CBAACB"},
      {"nombre":"VERDE CLARO","codigo":"#E2F0CB"},
      {"nombre":"AMARILLO","codigo":"#FFFF00"},
      {"nombre":"NARANJA","codigo":"#FFA500"},
      {"nombre":"MORADO","codigo":"#800080"},
      {"nombre":"CYAN","codigo":"#00FFFF"},
      {"nombre":"MAGENTA","codigo":"#FF00FF"},
      {"nombre":"GRIS","codigo":"#808080"},
      {"nombre":"NEGRO","codigo":"#000000"},
      {"nombre":"BLANCO","codigo":"#FFFFFF"}
  ] %}
  <option value="{{ c.codigo }}">{{ c.nombre }}</option>
  {% endfor %}
</select>
<button id="aplicarColor">Aplicar</button>

<!-- Bloque de Status en bloque -->
<label>Status en bloque:</label>
<input type="text" id="statusBloque" placeholder="Nuevo Status" style="width:100px;">
<button id="aplicarStatusSeleccionados">Aplicar a seleccionados</button>

<!-- Selecci√≥n/Deselecci√≥n -->
<button id="seleccionarFiltrados" style="background-color:#28a745;">Seleccionar</button>
<button id="deseleccionarTodos" style="background-color:#dc3545;">Deseleccionar</button>
</div>

<div id="filtros">
<input type="text" placeholder="Filtrar Sel" data-col="0">
<input type="text" placeholder="Filtrar Nombre" data-col="1">
<input type="text" placeholder="Filtrar Has" data-col="2">
<input type="text" placeholder="Filtrar Status" data-col="3">
<input type="text" placeholder="Filtrar Partido" data-col="4">
<input type="text" placeholder="Filtrar Color" data-col="5">
</div>

<table id="tablaPoligonos" class="display" style="width:100%">
<thead>
<tr>
<th>Sel</th>
<th>Nombre Productor</th>
<th>Has</th>
<th>Status</th>
<th>Ptdo</th>
<th>Color</th>
</tr>
</thead>
<tbody>
{% for p in poligonos %}
<tr data-index="{{ loop.index0 }}">
<td><input type="checkbox" class="selectFila"></td>
<td><input type="text" value="{{ p.name }}"></td>
<td><input type="text" value="{{ p.superficie }}"></td>
<td><input type="text" value="{{ p.status }}"></td>
<td><input type="text" value="{{ p.partido }}"></td>
<td><input type="color" value="{{ p.color }}" class="colorInput"></td>
</tr>
{% endfor %}
</tbody>
</table>

<div style="display:flex; gap:10px; margin-top:10px; position:relative;">
  <div style="flex:1; position:relative;">
    <button id="btn-grabar" style="width:100%; background-color:#007bff;">üíæ GUARDAR ‚ñº</button>
    <div id="menu-grabar" class="menu-grabar">
      <div id="opcion-grabar">üíæ Guardar cambios</div>
      <div id="opcion-grabar-como">üìù Guardar como...</div>
    </div>
  </div>
  <button id="exportarPDF" style="flex:1; background-color:#28a745;">üìÑ EXPORTAR A PDF</button>
</div>

</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
const rol = "{{ rol }}";
const poligonos = {{ poligonos|tojson }};
const map = L.map('map').setView([-35, -63], 8);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const leafletPoligonos = [];
poligonos.forEach((p)=> {
  if(p.coords && p.coords.length>0){
    const poly = L.polygon(p.coords,{
      color:"#0000FF",
      weight:0.5,
      fillColor:p.color,
      fillOpacity:0.6
    }).addTo(map)
    .bindPopup("<b>"+p.name+"</b><br>Superficie: "+p.superficie);
    
    poly.options._originalStyle = { color: poly.options.color, weight: poly.options.weight, fillColor: poly.options.fillColor, fillOpacity: poly.options.fillOpacity, opacity: poly.options.opacity || 1 };
    poly.options._currentFillColor = p.color;

    // ---- HOVER ----
    poly.on('mouseover', function(e){
        this.setStyle({ fillColor: "#7CFF7C", fillOpacity: 0.8 });
        this.bindTooltip(p.name, { permanent:false, direction:"top" }).openTooltip();
    });
    poly.on('mouseout', function(e){
        this.setStyle({ fillColor: p.color, fillOpacity: 0.6 });
        this.closeTooltip();
    });

    leafletPoligonos.push(poly);
  } else { leafletPoligonos.push(null); }
});


// ==== DataTable ====
const table = $('#tablaPoligonos').DataTable({
  paging: false,
  info: false,
  ordering: false,
  dom: 't',
  scrollY: "calc(100vh - 300px)",
  scrollCollapse: true,
  columnDefs: [
    { targets: 0, orderable: false,
      render: function(data,type,row,meta){
        const checkbox=$(data).find('input.selectFila');
        if(type==='filter'||type==='sort') return checkbox.prop('checked')?'S':'';
        return data;
      }
    },
    { targets:"_all",
      render:function(data,type,row,meta){
        const input=$('<div>').html(data).find('input');
        if(input.length && (type==='sort'||type==='filter')) return input.val()||"";
        return data;
      }
    }
  ]
});

// ==== Filtros ====
$('#filtros input').on('keyup change', function(){
  const col = $(this).data('col');
  table.column(col).search(this.value, true, false).draw();
});

// ==== Selecci√≥n y mapa ====
function actualizarSeleccionMapaTabla() {
  table.rows().every(function(){
    const row = $(this.node());
    const idx = row.data('index');
    const checkbox = row.find('.selectFila');
    const poly = leafletPoligonos[idx];
    if(!poly) return;
    const colorActual = row.find('.colorInput').val();
    poly.options._currentFillColor = colorActual;
    poly.options._originalStyle.fillColor = colorActual;

    if (checkbox.prop('checked')) {
      poly.setStyle({ weight:2, color:"#000", opacity:1, fillColor:colorActual });
      row.addClass('seleccionado');
    } else {
      poly.setStyle({ weight:0.5, color:"#0000FF", opacity:0.8, fillColor:colorActual, fillOpacity:0.6 });
      row.removeClass('seleccionado');
    }
  });
}

leafletPoligonos.forEach((poly, idx)=>{
  if(!poly) return;
  poly.on('click', ()=>{
    const fila = $(table.row(idx).node());
    const checkbox = fila.find('.selectFila');
    checkbox.prop('checked', !checkbox.prop('checked'));
    actualizarSeleccionMapaTabla();
    if(checkbox.prop('checked')) centrarFila(fila);
  });
});

$('#tablaPoligonos').on('change','.selectFila',()=>{ actualizarSeleccionMapaTabla(); });

function centrarFila(fila){
  const scrollBody=$('.dataTables_scrollBody');
  const filaTop=fila[0].offsetTop;
  const filaHeight=fila.outerHeight();
  const containerHeight=scrollBody.height();
  scrollBody.scrollTop(filaTop - containerHeight/2 + filaHeight/2);
}

function actualizarMapa(){
  table.rows().every(function(){
    const data=this.node();
    const idx=$(data).data('index');
    const poly = leafletPoligonos[idx];
    if(poly){
      const color=$(data).find('.colorInput').val();
      poly.options._currentFillColor = color;
      poly.options._originalStyle.fillColor = color;
      if($(data).find('.selectFila').prop('checked')){
        poly.setStyle({ fillColor: color, weight:2, color:"#000" });
      } else {
        poly.setStyle({ fillColor: color, weight:0.5, color:"#0000FF" });
      }
    }
  });
}

// ==== COLOR EN BLOQUE ====
$('#colorBloque').change(function(){
  const color=$(this).val();
  if(color){
    $('.selectFila:checked').closest('tr').find('.colorInput').val(color);
    actualizarMapa();
  }
});
$('#aplicarColor').click(function(){ $('#colorBloque').trigger('change'); });

// ==== STATUS EN BLOQUE (solo seleccionados) ====
$('#aplicarStatusSeleccionados').click(function () {
    const nuevoStatus = $('#statusBloque').val().toUpperCase().trim();
    if (!nuevoStatus) return;

    // 1Ô∏è‚É£ Guardar el ID de cada fila seleccionada (usamos contenido de la columna NOMBRE como identificador)
    const seleccionados = [];
    table.rows({ search: 'applied' }).every(function () {
        const $fila = $(this.node());
        if ($fila.find('.selectFila').prop('checked')) {
            const nombre = $fila.find('td:eq(1) input').val();
            if (nombre) seleccionados.push(nombre);
        }
    });

  // ==== STATUS EN BLOQUE (solo seleccionados) ====
$('#aplicarStatusSeleccionados').click(function () {
    const nuevoStatus = $('#statusBloque').val().toUpperCase().trim();
    if (!nuevoStatus) return;

    // Guardar filtros activos
    const filtrosActivos = [];
    $('#filtros input').each(function(){
        filtrosActivos.push($(this).val());
    });

    // Identificar filas seleccionadas por √≠ndice de DataTables
    const indicesSeleccionados = [];
    table.rows({ search: 'applied' }).every(function (rowIdx) {
        const $fila = $(this.node());
        if ($fila.find('.selectFila').prop('checked')) {
            indicesSeleccionados.push(rowIdx);
        }
    });

    // Actualizar STATUS en cada fila seleccionada
    indicesSeleccionados.forEach(idx => {
        const fila = table.row(idx).node();
        const celdas = $(fila).find('td');
        const rowData = table.row(idx).data();

        $(celdas[3]).find('input').val(nuevoStatus);
        rowData[3] = nuevoStatus;
        table.row(idx).data(rowData);
    });

    // Redibujar tabla sin perder filtros
    table.rows().invalidate('data').draw(false);

    // Restaurar filtros
    $('#filtros input').each(function(i){
        table.column(i).search(filtrosActivos[i], true, false);
    });
    table.draw(false);

    // Restaurar selecci√≥n
    indicesSeleccionados.forEach(idx => {
        const fila = table.row(idx).node();
        $(fila).find('.selectFila').prop('checked', true);
    });

    // Actualizar mapa
    actualizarSeleccionMapaTabla();
    actualizarMapa();
});


    // 5Ô∏è‚É£ Actualizar mapa y selecci√≥n visual
    actualizarSeleccionMapaTabla();
    actualizarMapa();
});

// ==== Seleccionar / Deseleccionar ====
$('#seleccionarFiltrados').click(function(){
  table.rows({search:'applied'}).nodes().to$().find('.selectFila').prop('checked',true);
  actualizarSeleccionMapaTabla();
});
$('#deseleccionarTodos').click(function(){
  table.rows().nodes().to$().find('.selectFila').prop('checked',false);
  actualizarSeleccionMapaTabla();
});

// ==== GUARDAR ====
const btnGrabar = $('#btn-grabar');
const menuGrabar = $('#menu-grabar');
btnGrabar.click(e=>{ e.stopPropagation(); menuGrabar.toggle(); });
$(document).click(e=>{ if(!menuGrabar.is(e.target) && !btnGrabar.is(e.target) && menuGrabar.has(e.target).length===0){ menuGrabar.hide(); } });

function obtenerDatosTabla(){
  const datos=[];
  table.rows().every(function(){
    const row=$(this.node());
    datos.push({
      index: row.data('index'),
      name: row.find('td:eq(1) input').val(),
      superficie: row.find('td:eq(2) input').val(),
      status: row.find('td:eq(3) input').val(),
      partido: row.find('td:eq(4) input').val(),
      color: row.find('td:eq(5) input').val()
    });
  });
  return datos;
}

$('#opcion-grabar').click(()=>{
  menuGrabar.hide();
  const datos = obtenerDatosTabla();
  $.ajax({
    url:'/guardar',
    method:'POST',
    contentType:'application/json',
    data: JSON.stringify(datos),
    success:function(resp){ actualizarMapa(); alert(resp.mensaje || '‚úÖ Cambios guardados correctamente.'); },
    error:function(){ alert('‚ùå Error al guardar.'); }
  });
});

$('#opcion-grabar-como').click(()=>{
  menuGrabar.hide();
  const nuevoNombre = prompt("Ingrese el nombre del nuevo archivo (sin extensi√≥n):");
  if(!nuevoNombre) return;
  const datos = obtenerDatosTabla();
  $.ajax({
    url:'/guardar_como',
    method:'POST',
    contentType:'application/json',
    data: JSON.stringify({ nuevo_nombre:nuevoNombre, datos:datos }),
    success:function(resp){ actualizarMapa(); alert(resp.mensaje || `‚úÖ Archivo guardado como ${nuevoNombre}.xlsx`); },
    error:function(){ alert('‚ùå Error al guardar el nuevo archivo.'); }
  });
});

// ==== EXPORTAR PDF ====
$('#exportarPDF').click(function(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text("Pol√≠gonos seleccionados", 14, 15);
  const filas=[];
  table.rows({search:'applied'}).nodes().to$().each(function(){
    const r=$(this);
    if(r.find('.selectFila').is(':checked')){
      filas.push([
        r.find('td:eq(0)').text(),
        r.find('td:eq(1) input').val(),
        r.find('td:eq(2) input').val(),
        r.find('td:eq(3) input').val(),
        r.find('td:eq(4) input').val(),
        r.find('td:eq(5) input').val()
      ]);
    }
  });
  const cabecera=['Sel','Nombre','Has','Status','Ptdo','Color'];
  doc.autoTable({ head:[cabecera], body:filas, startY:20, styles:{fontSize:9,cellPadding:2}, headStyles:{fillColor:[0,86,179],textColor:255,fontStyle:'bold'} });
  doc.save("poligonos.pdf");
});
</script>
</body>
</html>
